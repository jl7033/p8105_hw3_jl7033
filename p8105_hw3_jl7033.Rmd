---
title: "p8105_hw3_jl7033"
author: "Joe LaRocca"
date: "2024-10-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(p8105.datasets)
library(patchwork)
```

## Problem 1

```{r}

data(ny_noaa)

```

#### Cleaning the Data

```{r}

ny_noaa_clean = ny_noaa %>%
  janitor::clean_names() %>%
  separate(date, into = c("year", "month", "day"), sep = c(4, 7)) %>%
  mutate(month = str_remove(month, "-"),
         month = month.abb[as.numeric(month)],
         day = str_remove(day, "-"),
         prcp = as.numeric(prcp),
         snow = as.numeric(snow),
         snwd = as.numeric(snwd),
         tmax = as.numeric(tmax),
         tmin = as.numeric(tmin)) %>%
  arrange(desc(year))

```

This dataset contains weather information in New York State between the years 1981 and 2010 (I checked using the `arrange()` function). There are a total of over 2.5 million observations, and the variables measures include the amount of total precipitation, the amount of snowfall, and the maximum and minimum temperatures. About 56.3\% of the observations within the dataset have data for maxmimum and minimum temperature, whereas 94.3\%, 85.3\%, and 77.2\% of the observations have data for precipitation, snowfall, and `snwd`, respectively (I found these proportions by dividing the number of rows for which there is data by the total number of rows). For snowfall, the most commonly observed value is 0, since it doesn't snow during most of the year in New York State.

#### Plot 1: Average Max Temperature in January and July

```{r}

ny_noaa_clean %>%
  filter(month == "Jan" | month == "Jul") %>%
  ggplot(aes(x = tmax, fill = month)) + 
  geom_histogram(color = "black") + 
  facet_grid(. ~ month)

```

At least to the naked eye, there doesn't seem to be any significant outliers in either histogram of maximum temperatures; both look to be approximately symmetric, with the January histogram having a slightly greater spread than the July histogram. One question I have is what the tmax values mean, since they don't seem to align with Fahrenheit, Celsius, or Kelvin. 

#### Plot 2: Tmax vs. Tmin for the entire dataset / Snowfall Values

```{r}

temp_plot = ny_noaa_clean %>%
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex(bins = 40) + 
  labs(
    x = "Minimum Temperature",
    y = "Maximum Temperature"
  )

snow_plot = ny_noaa_clean %>%
  filter(snow > 0, snow < 100) %>%
  ggplot(aes(x = snwd)) + 
  geom_histogram() + 
  facet_wrap(. ~ year) +
  labs(
    x = "Snowfall"
  )

temp_plot + snow_plot

```

I decided on a hexagonal heat map over a scatterplot due to the size of the dataset, as we were advised to look for alternatives to typical scatterplots with especially large datasets. Using this map, we can see that the largest densities of points appear between a `tmin` of 0 and 200 and a `tmax` of 0 and 300, with a clear positive correlation between the two variables (which makes sense, as we would expect a day with a higher minimum temperature to have a higher maxmimum temperature, too).

## Problem 2

#### Upload and Merge the Data

```{r, message = FALSE}

demographics_df = read_csv("nhanes_covar.csv", skip = 4) %>%
  janitor::clean_names()

accel_df = read_csv("nhanes_accel.csv") %>%
  janitor::clean_names()

mims_df = left_join(demographics_df, accel_df)

```

#### Clean the Data

```{r}

mims_df_clean = mims_df %>%
  filter(age >= 21, !is.na(sex & age & bmi & education)) %>%
  mutate(sex = as.factor(
    case_match(
           sex, 
           1 ~ "Male",
           2 ~ "Female"
         )
  ), 
  education = as.factor(
    case_match(
      education,
      1 ~ "Less Than HS",
      2 ~ "HS Equivalent",
      3 ~ "More Than HS")
    )
  ) 

```

#### Table for Men and Women by Education

```{r}

mims_df_clean %>%
  group_by(sex, education) %>%
  janitor::tabyl(sex, education)

```

We can see in this table than the most common education level is having completed more than high school, with approximately the same number of participants having not completed high school and having completed a high school equivalent.

#### Plot for Age Distributions of Men and Women

```{r}

mims_df_clean %>%
  group_by(sex, education) %>%
  ggplot(aes(x = age, fill = sex)) + 
  geom_histogram(color = "black") + 
  facet_wrap(sex ~ education) + 
  labs(
    title = "Distribution of Age by Gender and Education",
    fill = "Sex",
    x = "Age",
    y = "Count"
  )

```

In this plot, we can see that the distribution of age by sex seems to be approximately equal, though there appears to be an especially large concentration of younger women (between 21 and 40 years old) who have completed more than a high school education. The age distributions of those who have not completed high school or completed a high school equivalent, on the other hand, look relatively uniform regardless of gender, and generally have a larger concentration of older participants than the group who has completed more than high school.

#### Plot of Activity Based on Age, across Sex and Education

```{r}

mims_df_clean %>%
  mutate(total_mims = rowSums(across(c(min1:min1440)))) %>%
  ggplot(aes(x = age, y = total_mims, color = sex)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(sex ~ education) + 
  labs(
    title = "Scatter Plot of Total MIMS by Age Across Sex and Education",
    color = "Sex",
    x = "Age",
    y = "Total MIMS"
  )

```

From the plot, we can see that the correlation between total MIMS and age looks to be negative, regardless of sex and education. The association between age and total MIMS looks to be weaker for both men and women with a higher level of education, with the "less than HS" group having the strongest association and the "more than HS" group having the weakest association. Finally, the average total MIMS does not seem to be significantly different among women and men.

#### Activity Plot over the Course of the Day

```{r}

mims_df_clean %>%
  pivot_longer(
    cols = min1:min1440,
    names_to = "minute",
    values_to = "MIMS",
    names_prefix = "min"
  ) %>%
  mutate(minute = as.numeric(minute)) %>%
  ggplot(aes(x = minute, y = MIMS, color = sex)) + 
    geom_point() + 
    facet_wrap(. ~ education) + 
  labs(
    title = "Scatterplots of MIMS by Minute Across Sex and Education",
    x = "Minute",
    color = "Sex"
  )

```

In order to create this plot, I created two new variables called `minute` and `MIMS` so that MIMS can be plotted as a function of the minute of the day.

For all three groups, MIMS activity looks to be low towards the far left end of the graph, which makes sense given that "minute 0" represents midnight, and so the subsequent hours would be in the middle of the night. As the day goes on, the total MIMS generally increases. One interesting trend is that among the "more than HS" group, the peak for women appears to be much earlier than the peak for men, and both peaks are well above those for the "less than HS" and "HS Equivalent" groups.

## Problem 3

#### Import, Tidy, Combine the Data

```{r}

citi_jan_2020 = read_csv("data/Jan 2020 Citi.csv") %>%
  janitor::clean_names() %>%
  mutate(time = "Jan_2020")

citi_jul_2020 = read_csv("data/July 2020 Citi.csv") %>%
  janitor::clean_names() %>%
  mutate(time = "Jul_2020")
  
citi_jan_2024 = read_csv("data/Jan 2024 Citi.csv") %>%
  janitor::clean_names() %>%
  mutate(time = "Jan_2024")

citi_jul_2024 = read_csv("data/July 2024 Citi.csv") %>%
  janitor::clean_names() %>%
  mutate(time = "Jul_2024")

citi_df = bind_rows(citi_jan_2020, 
                citi_jul_2020,
                citi_jan_2024,
                citi_jul_2024)

citi_jul_2024

```

#### Describing the Dataset

In the total dataset, there are approximately 100,000 Citi Bike rides between January 2020, July 2020, January 2024, and July 2024. The time period with the most rides is July 2024 (~47\% of rides), which is not surprising, considering that more people generally ride bikes in the summer than the winter and July 2020 was in the middle of the COVID-19 pandemic. 

The columns of the dataset describe the ride's unique ID, the type of bike ridden (classic or electric), the day of the week the ride was on, the duration of the ride (in minutes), the stations where the ride started and ended, and whether the rider was a Citi Bike member or a casual rider.

#### Total Number of Rides / Casual/Member Table

##### Using janitor::tabyl

```{r}

citi_df %>%
  janitor::tabyl(time, member_casual) %>%
  mutate(pct_member = member / (member + casual) * 100)

```

##### Alternative: using the summarize() function

```{r}

citi_df %>%
  group_by(time, member_casual) %>%
  summarize(n_obs = n()) %>%
  pivot_wider(
    names_from = member_casual,
    values_from = n_obs
  )

```

We can see that the total number of Citi Bike riders increased over time; in fact, there were more recorded rides in January 2024 -- in the middle of winter -- than in July of 2020 (the COVID pandemic may have been a factor). I added the `pct_member` column to this table to illustrate that the proportion of members generally decreased from 2020 to 2024 -- that is, Citi Bike attracted a larger portion of casual riders in 2024 than it did in 2020.

#### Table of 5 most popular starting stations


